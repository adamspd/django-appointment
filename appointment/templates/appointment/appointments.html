{% extends BASE_TEMPLATE %}
{% load i18n %}
{% load static %}
{% block customCSS %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/appt-common.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/appointments.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/recurring-enhancement.css' %}"/>
{% endblock %}
{% block title %}
    {{ page_title }}
{% endblock %}
{% block description %}
    {{ page_description }}
{% endblock %}
{% block body %}
    <div class="container">
        <div class="djangoAppt_main-container">
            <div class="djangoAppt_body-container">
                <h1 class="page-title">
                    {% if page_header %}{{ page_header }}{% else %}{{ service.name }}{% endif %} </h1>
                <small class="page-description">
                    {% trans "Check out our availability and book the date and time that works for you" %}
                </small>
                <hr>

                <div class="djangoAppt_page-body">
                    <div class="djangoAppt_appointment-calendar">
                        <div class="djangoAppt_appointment-calendar-title-timezone">
                            <div class="djangoAppt_title">
                                {% trans "Select a date and time" %}
                            </div>
                            <div class="djangoAppt_timezone-details">
                                {% trans "Timezone" %}:&nbsp;{{ timezoneTxt }}
                            </div>
                        </div>
                        <hr class="djangoAppt_second-part">
                        <div class="djangoAppt_calendar-and-slot">
                            <div class="djangoAppt_calendar" id="calendar">
                            </div>
                            <div class="djangoAppt_slot">
                                <div class="djangoAppt_date_chosen">{{ date_chosen }}</div>
                                <div class="slot-container">
                                    <div class="error-message"></div>
                                    <ul id="slot-list" class="djangoAppt_slot-list">
                                        <!-- Slot list will be updated dynamically by the AJAX request -->
                                    </ul>
                                </div>

                            </div>
                        </div>
                        {% if rescheduled_date %}
                            <div class="form-group" style="margin-top: 10px">
                                <label for="reason_for_rescheduling">{% trans "Reason for rescheduling" %}:</label>
                                <textarea name="reason_for_rescheduling" id="reason_for_rescheduling"
                                          class="form-control" rows="1" required></textarea>
                            </div>
                        {% endif %}
                    </div>
                    <div class="djangoAppt_service-description">
                        <div class="staff-members-list">
                            <label class="djangoAppt_item-name" for="staff_id">{{ label }}</label>
                            <select name="staff_member" id="staff_id">
                                {% if not staff_member %}
                                    <option value="none"
                                            selected>{% trans 'Please select a staff member' %}</option>
                                {% endif %}
                                {% for sf in all_staff_members %}
                                    <option value="{{ sf.id }}"
                                            {% if staff_member and staff_member.id == sf.id %}selected{% endif %}>{{ sf.get_staff_member_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>{% trans "Service Details" %}</div>
                        <hr class="djangoAppt_second-part">
                        <div class="djangoAppt_service-description-content">
                            <p class="djangoAppt_item-name">{{ service.name }}</p>
                            <p id="service-datetime-chosen" class="service-datetime-chosen">{{ date_chosen }}</p>
                            <p>{{ service.get_duration }}</p>
                            <p>{{ service.get_price_text }}</p>
                            <!-- NO SUBMIT BUTTON HERE ANYMORE -->
                        </div>
                    </div>
                </div>

                <!-- FULL WIDTH: Recurring Settings Section -->
                <div class="recurring-section-wrapper">
                    <div class="recurring-toggle-wrapper">
                        <label for="id_is_recurring" class="recurring-toggle-label">
                            <input type="checkbox" name="is_recurring" id="id_is_recurring" class="recurring-checkbox">
                            <span class="recurring-toggle-switch"></span>
                            <span class="recurring-toggle-text">{% trans "Recurring Appointment?" %}</span>
                        </label>
                    </div>

                    <div id="recurrence_rule_fields" class="recurring-config-panel" style="display:none;">
                        <div class="recurring-form-grid">
                            <div class="recurring-field">
                                <label class="recurring-label">{% trans "Repeat every" %}</label>
                                <select id="recurrence_frequency" class="recurring-select">
                                    <option value="DAILY">{% trans "Day" %}</option>
                                    <option value="WEEKLY" selected>{% trans "Week" %}</option>
                                    <option value="MONTHLY">{% trans "Month" %}</option>
                                </select>
                            </div>

                            <div class="recurring-field" id="weekly_day_selection">
                                <label class="recurring-label">{% trans "On these days" %}</label>
                                <div class="day-picker">
                                    <button type="button" class="day-button" data-day="MO">M</button>
                                    <button type="button" class="day-button" data-day="TU">T</button>
                                    <button type="button" class="day-button" data-day="WE">W</button>
                                    <button type="button" class="day-button" data-day="TH">T</button>
                                    <button type="button" class="day-button" data-day="FR">F</button>
                                    <button type="button" class="day-button" data-day="SA">S</button>
                                    <button type="button" class="day-button" data-day="SU">S</button>
                                </div>
                            </div>

                            <div class="recurring-field">
                                <label for="id_end_recurrence" class="recurring-label">{% trans "Until" %}</label>
                                <input type="date" name="end_recurrence" id="id_end_recurrence"
                                       class="recurring-date-input">
                            </div>
                        </div>

                        <div class="recurring-preview-box">
                            <span id="recurring_preview_text">{% trans "Configure settings to see preview" %}</span>
                        </div>
                    </div>
                </div>

                <!-- FULL WIDTH: Submit Button Section -->
                <div class="submit-section-wrapper">
                    <form method="post" action="{% url 'appointment:appointment_request_submit' %}"
                          class="appointment-form">
                        {% csrf_token %}

                        <!-- Hidden fields to capture form data -->
                        <input type="hidden" name="staff_member" id="hidden_staff_member" value="">
                        <input type="hidden" name="selected_date" id="hidden_selected_date" value="">
                        <input type="hidden" name="selected_time" id="hidden_selected_time" value="">
                        <input type="hidden" name="service_id" value="{{ service.id }}">

                        <!-- Recurring fields -->
                        <input type="hidden" name="is_recurring" id="hidden_is_recurring" value="false">
                        <textarea name="recurrence_rule" id="id_recurrence_rule" style="display: none;"></textarea>
                        <input type="hidden" name="end_recurrence" id="hidden_end_recurrence" value="">

                        {% if rescheduled_date %}
                            <input type="hidden" name="reason_for_rescheduling" id="hidden_reason_for_rescheduling"
                                   value="">
                        {% endif %}

                        <button type="submit" class="btn btn-primary btn-submit-appointment" disabled>
                            {% trans 'Next' %}
                        </button>
                    </form>
                </div>

                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-dismissible {% if message.tags %}alert-{% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}danger{% else %}{{ message.tags }}{% endif %}{% endif %}"
                             role="alert">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block customJS %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.js"
            integrity="sha512-3CuraBvy05nIgcoXjVN33mACRyI89ydVHg7y/HMN9wcTVbHeur0SeBzweSd/rxySapO7Tmfu68+JlKkLTnDFNg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"
            integrity="sha512-t/mY3un180WRfsSkWy4Yi0tAxEDGcY2rAEx873hb5BrkvLA0QLk54+SjfYgFBBoCdJDV1H86M8uyZdJhAOHeyA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"
            integrity="sha512-JCQkxdym6GmQ+AFVioDUq8dWaWN6tbKRhRyHvYZPupQ6DxpXzkW106FXS1ORgo/m3gxtt5lHRMqSdm2OfPajtg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const timezone = "{{ timezoneTxt }}";
        const locale = "{{ locale }}";
        const availableSlotsAjaxURL = "{% url 'appointment:available_slots_ajax' %}";
        const requestNextAvailableSlotURLTemplate = "{% url 'appointment:request_next_available_slot' service_id=0 %}";
        const getNonWorkingDaysURL = "{% url 'appointment:get_non_working_days_ajax' %}";
        const serviceId = "{{ service.id }}";
        const serviceDuration = parseInt("{{ service.duration.total_seconds }}") / 60;
        const rescheduledDate = "{{ rescheduled_date }}";
        const appointmentRequestId = "{{ ar_id_request }}";
        const appointmentRequestSubmitURL = "{% url 'appointment:appointment_request_submit' %}";
        const appointmentRescheduleURL = "{% url 'appointment:reschedule_appointment_submit' %}";
    </script>
    <script>
        const requestNonAvailableSlotBtnTxt = "{% trans 'Request next available slot' %}";
        const noStaffMemberSelectedTxt = "{% trans 'No staff member selected.' %}";
        const selectTimeSlotWarningTxt = "{% trans 'Please select a time slot before submitting the appointment request.' %}";
        const dateInPastErrorTxt = "{% trans 'Date is in the past.' %}";
        const selectDateAndTimeAlertTxt = "{% trans 'Please select a date and time' %}";
    </script>
    <script src="{% static 'js/appointments.js' %}"></script>
    <script src="{% static 'js/js-utils.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const isRecurringCheckbox = document.getElementById('id_is_recurring');
            const recurrenceFieldsDiv = document.getElementById('recurrence_rule_fields');
            const frequencySelect = document.getElementById('recurrence_frequency');
            const weeklyDaySelection = document.getElementById('weekly_day_selection');
            const dayButtons = document.querySelectorAll('.day-button');
            const endDateInput = document.getElementById('id_end_recurrence');
            const rruleInput = document.getElementById('id_recurrence_rule');
            const previewText = document.getElementById('recurring_preview_text');

            // Debug function to see what's actually in the DOM
            function debugCalendarState() {
                console.log('=== DEBUG CALENDAR STATE ===');
                console.log('window.selectedDate:', window.selectedDate);
                console.log('Selected cell elements:', document.querySelectorAll('.selected-cell'));
                console.log('FC day elements:', document.querySelectorAll('[class*="fc-day"]'));
                console.log('All elements with data-date:', document.querySelectorAll('[data-date]'));

                // Try to find the actually selected calendar day
                const selectedCell = document.querySelector('.selected-cell');
                if (selectedCell) {
                    console.log('Found selected cell:', selectedCell);
                    console.log('Selected cell attributes:', selectedCell.attributes);
                    console.log('Selected cell data-date:', selectedCell.getAttribute('data-date'));
                }
            }

            // Sync form data with hidden fields
            function syncFormData() {
                const staffSelect = document.getElementById('staff_id');
                const hiddenStaff = document.getElementById('hidden_staff_member');
                const hiddenIsRecurring = document.getElementById('hidden_is_recurring');
                const hiddenEndRecurrence = document.getElementById('hidden_end_recurrence');

                if (staffSelect && hiddenStaff) {
                    hiddenStaff.value = staffSelect.value;
                }

                if (hiddenIsRecurring) {
                    hiddenIsRecurring.value = isRecurringCheckbox.checked ? 'true' : 'false';
                }

                if (hiddenEndRecurrence && endDateInput) {
                    hiddenEndRecurrence.value = endDateInput.value;
                }
            }

            // Make this function globally available so appointments.js can call it
            window.syncRecurringWithCalendarSelection = function () {
                console.log('syncRecurringWithCalendarSelection called');
                debugCalendarState();

                if (!document.getElementById('id_is_recurring').checked ||
                    document.getElementById('recurrence_frequency').value !== 'WEEKLY') {
                    console.log('Not syncing - recurring not enabled or not weekly');
                    return;
                }

                let dateStr = null;

                // Try multiple ways to get the selected date

                // Method 1: Use global selectedDate variable
                if (window.selectedDate) {
                    dateStr = window.selectedDate;
                    console.log('Using window.selectedDate:', dateStr);
                }

                // Method 2: Find selected cell and get its data-date
                if (!dateStr) {
                    const selectedCell = document.querySelector('.selected-cell');
                    if (selectedCell) {
                        dateStr = selectedCell.getAttribute('data-date');
                        console.log('Using selected cell data-date:', dateStr);
                    }
                }

                // Method 3: Check the date display text
                if (!dateStr) {
                    const dateChosen = document.querySelector('.djangoAppt_date_chosen');
                    if (dateChosen && dateChosen.textContent) {
                        // This would need parsing, but let's see what we get
                        console.log('Date chosen text:', dateChosen.textContent);
                    }
                }

                if (dateStr) {
                    const date = new Date(dateStr);
                    const dayOfWeek = date.getDay();
                    const dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                    const dayCode = dayMapping[dayOfWeek];

                    console.log('Date:', dateStr, 'Day of week:', dayOfWeek, 'Day code:', dayCode);

                    // Clear existing selections
                    document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('selected'));

                    // Select the matching day
                    const dayButton = document.querySelector(`.day-button[data-day="${dayCode}"]`);
                    if (dayButton) {
                        dayButton.classList.add('selected');
                        console.log('Selected day button:', dayCode);
                        updateRecurrenceRule();
                    } else {
                        console.log('Day button not found for:', dayCode);
                    }
                } else {
                    console.log('No date string found');
                }
            };

            function updateRecurrenceRule() {
                const frequency = frequencySelect.value;
                let rrule = `RRULE:FREQ=${frequency}`;

                if (frequency === 'WEEKLY') {
                    const selectedDays = Array.from(document.querySelectorAll('.day-button.selected'))
                        .map(btn => btn.dataset.day);
                    if (selectedDays.length > 0) {
                        rrule += `;BYDAY=${selectedDays.join(',')}`;
                    }
                }

                if (endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                    rrule += `;UNTIL=${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`;
                }

                rruleInput.value = rrule;
                updatePreview();
            }

            function updatePreview() {
                const frequency = frequencySelect.value;
                const endDate = endDateInput.value;
                let previewHtml = '';

                if (frequency === 'WEEKLY') {
                    const selectedDays = Array.from(document.querySelectorAll('.day-button.selected'));
                    if (selectedDays.length > 0) {
                        const dayNames = selectedDays.map(btn => {
                            const day = btn.dataset.day;
                            const names = {MO: 'Mon', TU: 'Tue', WE: 'Wed', TH: 'Thu', FR: 'Fri', SA: 'Sat', SU: 'Sun'};
                            return names[day];
                        });
                        previewHtml = `Every week on ${dayNames.join(', ')}`;
                    } else {
                        previewHtml = 'Select days for weekly recurrence';
                    }
                } else if (frequency === 'DAILY') {
                    previewHtml = 'Every day';
                } else if (frequency === 'MONTHLY') {
                    previewHtml = 'Every month';
                }

                if (endDate && previewHtml) {
                    previewHtml += ` until ${new Date(endDate).toLocaleDateString()}`;
                }

                previewText.textContent = previewHtml || 'Configure settings';
            }

            // Toggle recurring settings visibility
            if (isRecurringCheckbox && recurrenceFieldsDiv) {
                isRecurringCheckbox.addEventListener('change', function () {
                    recurrenceFieldsDiv.style.display = this.checked ? 'block' : 'none';
                    if (this.checked && frequencySelect.value === 'WEEKLY') {
                        setTimeout(() => window.syncRecurringWithCalendarSelection(), 100);
                    } else {
                        rruleInput.value = '';
                    }
                    syncFormData();
                });
            }

            // Handle frequency changes
            frequencySelect.addEventListener('change', function () {
                weeklyDaySelection.style.display = this.value === 'WEEKLY' ? 'block' : 'none';
                if (this.value === 'WEEKLY') {
                    setTimeout(() => window.syncRecurringWithCalendarSelection(), 100);
                }
                updateRecurrenceRule();
            });

            // Handle day button clicks
            dayButtons.forEach(button => {
                button.addEventListener('click', function () {
                    this.classList.toggle('selected');
                    updateRecurrenceRule();
                });
            });

            // Set date constraints for the until field
            function setDateConstraints() {
                const today = new Date();
                const maxDate = new Date();
                maxDate.setMonth(today.getMonth() + {{ max_recurring_months|default:3 }}); // 3 months from now

                // Format dates for input[type="date"]
                const todayStr = today.toISOString().split('T')[0];
                const maxDateStr = maxDate.toISOString().split('T')[0];

                endDateInput.setAttribute('min', todayStr);
                endDateInput.setAttribute('max', maxDateStr);
            }

            // Validate end date input
            function validateEndDate() {
                const selectedDate = new Date(endDateInput.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const maxDate = new Date();
                maxDate.setMonth(today.getMonth() + 3);
                maxDate.setHours(23, 59, 59, 999);

                if (selectedDate < today) {
                    alert('End date cannot be in the past.');
                    endDateInput.value = '';
                    return false;
                }

                if (selectedDate > maxDate) {
                    alert('End date cannot be more than 3 months from today.');
                    endDateInput.value = '';
                    return false;
                }

                return true;
            }

            // Handle end date changes
            endDateInput.addEventListener('change', function () {
                if (validateEndDate()) {
                    updateRecurrenceRule();
                    syncFormData();
                }
            });

            // Sync staff selection
            const staffSelect = document.getElementById('staff_id');
            if (staffSelect) {
                staffSelect.addEventListener('change', syncFormData);
            }

            // Initialize
            weeklyDaySelection.style.display = frequencySelect.value === 'WEEKLY' ? 'block' : 'none';
            setDateConstraints(); // Set the date constraints on load
            syncFormData();

            // Debug on page load
            setTimeout(debugCalendarState, 1000);
        });
    </script>
    {% if form %}{{ form.media }}{% endif %}
{% endblock %}
